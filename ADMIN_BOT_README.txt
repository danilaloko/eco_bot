Админ-бот для Эко-бота

Административная панель для управления экологическим Telegram-ботом. Предоставляет полный контроль над заданиями, отчетами пользователей и статистикой системы.

Основные возможности

Управление заданиями
- Добавление новых заданий с автоматическим расчетом дедлайнов
- Редактирование существующих заданий
- Изменение статуса (открыто/закрыто)
- Удаление заданий с подтверждением
- Просмотр статистики по каждому заданию

Работа с отчетами
- Модерация отчетов - одобрение/отклонение
- Потенциальные отчеты - обработка сообщений вне контекста
- Просмотр отчетов по заданиям и пользователям
- Профили пользователей с детальной статистикой
- Фильтрация по статусам и типам отчетов

Аналитика и статистика
- Общая статистика системы
- Данные пользователей (регистрации, активность)
- Статистика отчетов (одобрение, соблюдение дедлайнов)
- Метрики по заданиям

Системные функции
- Экспорт данных в форматах CSV и ZIP
  - Экспорт пользователей с полной регистрационной информацией
  - Экспорт заданий с метаданными и статусами
  - Экспорт отчетов с привязкой к пользователям и заданиям
  - Полная выгрузка всех данных в ZIP архиве с документацией
- Очистка системных логов с детальной статистикой
  - Удаление обработанных потенциальных отчетов
  - Очистка старых офлайн-сообщений (>30 дней)
  - Удаление устаревших состояний пользователей (>7 дней)
  - Архивирование закрытых запросов поддержки (>30 дней)
  - Оптимизация базы данных с помощью VACUUM
- Обработка потенциальных отчетов с интеллектуальными возможностями
  - Просмотр содержимого с контекстной информацией
  - Привязка к существующим заданиям одним кликом
  - Просмотр прикрепленных файлов (фото, видео, документы)
  - Отметка как обработанные или удаление
- Контроль доступа для нескольких администраторов

Установка и настройка

1. Создание админ-бота в Telegram

1. Напишите @BotFather в Telegram
2. Отправьте команду /newbot
3. Придумайте имя для админ-бота (например, "Эко-бот Админ")
4. Придумайте username (например, "eco_bot_admin")
5. Скопируйте полученный токен

2. Настройка переменных окружения

Добавьте в файл .env следующие переменные:

# Основной бот
BOT_TOKEN=your_main_bot_token_here
ADMIN_ID=your_telegram_id_here

# Админ-бот
ADMIN_BOT_TOKEN=your_admin_bot_token_here
ADMIN_IDS=your_telegram_id_here,additional_admin_id

# Можно указать несколько администраторов через запятую
# ADMIN_IDS=123456789,987654321,555666777

# Для тестирования - открытый доступ всем (НЕБЕЗОПАСНО!)
# ADMIN_IDS=all

3. Установка зависимостей

Убедитесь, что установлены все необходимые зависимости:

pip install python-telegram-bot python-dotenv pytz

4. Запуск админ-бота

python admin_bot.py

Использование

Первый запуск

1. Запустите админ-бота: python admin_bot.py
2. Найдите вашего админ-бота в Telegram по username
3. Отправьте команду /start
4. Если ваш ID указан в ADMIN_IDS, вы получите доступ к панели

Основные разделы

Задания
- Добавить задание - пошаговое создание нового задания
- Список заданий - просмотр всех заданий с быстрым доступом к управлению

При добавлении задания система запросит:
1. Название (минимум 5 символов)
2. Описание (подробное описание задания)
3. Ссылку (необязательно, для дополнительных материалов)
4. Номер недели (для группировки заданий)
5. Дедлайн (автоматический или ручной ввод)

Отчеты
- Ожидающие проверки - отчеты, требующие модерации
- Все отчеты - полный список с фильтрацией
- Потенциальные отчеты - сообщения пользователей вне контекста

Для каждого отчета доступно:
- Одобрение - засчитывает отчет как выполненный
- Отклонение - отклоняет отчет
- Профиль пользователя - детальная информация об отправителе
- Переход к заданию - просмотр связанного задания

Статистика
Отображает актуальные данные:
- Количество пользователей и уровень регистраций
- Статистику по заданиям (всего, открытых)
- Данные по отчетам (всего, ожидающих, одобренных)
- Процентные показатели активности

Безопасность

Контроль доступа
- Только пользователи с ID из ADMIN_IDS получают доступ
- Все остальные получают сообщение об отказе в доступе
- Логирование всех попыток доступа
- Специальный режим: ADMIN_IDS=all - открытый доступ для всех (только для тестирования!)

Рекомендации
1. Не делитесь токеном админ-бота
2. Ограничьте круг администраторов только доверенными лицами
3. Регулярно проверяйте логи на предмет подозрительной активности
4. Используйте отдельный токен для админ-бота (не основного)
5. НИКОГДА не используйте ADMIN_IDS=all в продакшене! Только для тестирования!

Примеры использования

Ежедневная работа администратора

1. Утром - проверка новых отчетов:
   Отчеты → Ожидающие проверки

2. Модерация отчетов:
   - Просмотр содержимого
   - Проверка соответствия заданию
   - Одобрение или отклонение

3. Добавление новых заданий (понедельник/четверг):
   Задания → Добавить задание

4. Контроль статистики:
   Статистика → просмотр общих показателей

Еженедельные задачи

1. Анализ активности пользователей
2. Планирование новых заданий
3. Обработка потенциальных отчетов
4. Архивация старых заданий

Системное администрирование

1. Экспорт данных для анализа:
   Система → Экспорт данных → Полная выгрузка
   - Получение всех данных в ZIP архиве
   - Анализ в Excel или других программах
   - Резервное копирование важной информации

2. Обработка потенциальных отчетов:
   Отчеты → Потенциальные отчеты → выбор отчета
   - Просмотр содержимого и контекста
   - Привязка к подходящему заданию
   - Одобрение в качестве официального отчета

3. Очистка системы (раз в месяц):
   Система → Очистка логов → подтверждение
   - Проверка статистики перед очисткой
   - Экспорт данных при необходимости
   - Освобождение места в базе данных

4. Мониторинг производительности:
   Статистика → анализ показателей
   - Отслеживание роста пользователей
   - Контроль качества отчетов
   - Планирование развития проекта

Интеграция с основным ботом

Админ-бот работает с той же базой данных (eco_bot.db), что и основной бот:

- Задания создаются через админ-бота и сразу доступны пользователям
- Отчеты пользователей сразу видны в админ-панели
- Изменения статусов мгновенно отражаются в основном боте
- Статистика обновляется в реальном времени

Структура данных

Таблицы базы данных
- tasks - задания с метаданными
- submissions - отчеты пользователей
- users - информация о пользователях
- offline_messages - потенциальные отчеты и служебные сообщения

Статусы отчетов
- pending - ожидает проверки (по умолчанию)
- approved - одобрен администратором
- rejected - отклонен администратором

Устранение неполадок

Частые проблемы

Ошибка: "ADMIN_BOT_TOKEN не найден"
# Решение: добавьте токен в .env файл
echo "ADMIN_BOT_TOKEN=your_token_here" >> .env

Ошибка: "Доступ запрещен"
# Решение: проверьте ADMIN_IDS в .env файле
echo "ADMIN_IDS=your_telegram_id" >> .env

# Для тестирования можно открыть доступ всем (НЕБЕЗОПАСНО!)
echo "ADMIN_IDS=all" >> .env

Проблемы с базой данных
# Решение: убедитесь что основной бот создал базу
python bot.py  # запустите основной бот сначала

Логирование

Админ-бот ведет подробные логи:
# Просмотр логов в реальном времени
python admin_bot.py 2>&1 | tee admin_bot.log

Продвинутые функции

Пакетное управление

Для массовых операций можно использовать прямые SQL запросы через базу данных:

# Пример: одобрить все отчеты старше недели
from database import Database
db = Database()
with db._get_connection() as conn:
    cursor = conn.cursor()
    cursor.execute("""
        UPDATE submissions 
        SET status = 'approved' 
        WHERE status = 'pending' 
        AND submission_date < date('now', '-7 days')
    """)
    conn.commit()

Автоматизация

Можно создать скрипты для автоматического управления:

# Пример: еженедельное создание заданий
#!/bin/bash
# weekly_tasks.sh
python -c "
from admin_bot import AdminBot
from datetime import datetime
import pytz

bot = AdminBot()
week = datetime.now(bot.moscow_tz).isocalendar()[1]
# Логика создания заданий...
"

Поддержка

При возникновении проблем:

1. Проверьте логи - большинство ошибок описаны в выводе
2. Убедитесь в правильности конфигурации - проверьте .env файл
3. Проверьте права доступа - ваш ID должен быть в ADMIN_IDS
4. Убедитесь что основной бот работает - админ-бот зависит от его базы данных

Обновления

При обновлении кода:

1. Остановите админ-бота (Ctrl+C)
2. Обновите код
3. Перезапустите: python admin_bot.py

База данных и конфигурация сохраняются между перезапусками.

Админ-бот - ваш надежный помощник в управлении экологическими инициативами! 